set nocompatible                                             " Treure la compatibilitat amb Vi

filetype off
filetype plugin indent on
filetype plugin on

call plug#begin('~/.vim/plugged')
Plug 'Lokaltog/vim-easymotion'                      " Per saltar entre paraules, cerques, etc. de manera més àgil
Plug 'adelarsq/vim-matchit'                         " Extén els tipus de coincidències de la comanda %
Plug 'airblade/vim-gitgutter'                       " Mostra canvis git al fitxer i més
Plug 'chrisbra/Colorizer'                           " Mostra el color dels codis i noms de color del text
Plug 'christoomey/vim-tmux-navigator'               " Navegar fluidament entre tmux i vim
Plug 'gillyb/stable-windows'                        " Manté estable la finestra quan hi ha canvis de layout (help, fzf...)
Plug 'gorkunov/smartpairs.vim'                      " Seleccions incrementals utilitzant v consecutivament
Plug 'int3/vim-extradite'                           " Amplia funcionalitat de fugitive mostrant commits
if has('nvim')
    Plug 'yuki-ycino/fzf-preview.vim'                   " Ús de FZF a una finestra flotant de neovim
else
    Plug 'junegunn/fzf', { 'do': { -> fzf#install() } } " Permet utilitzar fzf dins de vim
    Plug 'junegunn/fzf.vim'                             " Permet utilitzar fzf dins de vim
endif
Plug 'keith/swift.vim'                              " Permet ressaltar colors i indentar fitxers Swift
Plug 'lifepillar/vim-solarized8'                    " Esquema de colors Solarized
Plug 'machakann/vim-highlightedyank'                " Destaca en vermell el text copiat al portapapers
Plug 'mbbill/undotree'                             " Mostra l'arbre de modificacions d'un fitxer
Plug 'mhinz/vim-grepper'                            " Utilitza llibreries externes (ag, rg) per omplir la llista quicklist o location
Plug 'pbrisbin/vim-mkdir'                           " Crea els directoris necessaris en guardar un fitxer
Plug 'szw/vim-g'                                    " Obre una pestanya al navegador amb el text a buscar (DuckDuckGo)
Plug 'tpope/vim-fugitive'                           " Utilitzar Git dins de Vim
Plug 'tpope/vim-repeat'                             " Permet utilitzar '.' per repetir comandes de surround.vim, speeddating.vim, unimpaired.vim, vim-easyclip i vim-easyclip
Plug 'tpope/vim-surround'                           " mitjançant l'acció 's' es posen i treuen parentesis, claudators, cometes simples, un tag...
Plug 'tpope/vim-unimpaired'                         " Utilitzant [ i ] es poden realitzar moviments o canvis de text o canvis de comportaments
Plug 'vim-airline/vim-airline'                      " Barra d'estat i de buffers/tabs
Plug 'vim-airline/vim-airline-themes'               " Barra d'estat i de buffers/tabs
Plug 'w0rp/ale'                                     " Revisar sintaxi de fitxers
Plug 'xolox/vim-misc'                               "
Plug 'xolox/vim-session'                            " Amplia la gestió de sessions de vim (necessita miv-misc
call plug#end()

filetype on

""""""""""""""""""""""""""""""""""""""""""""""""""
" Funcions
"""""""""""""""""""""""""""""""""""""""""""""""""""
function! EnsureDirExists (dir)
" Funció per crear directoris si no existeixen
    if !isdirectory(a:dir)
        if exists('*mkdir')
            call mkdir(a:dir,'p')
        endif
    endif
endfunc

function! DeleteTrailingWS()
" Funció per esborrar els espais a final de línia del buffer
    let previous_search=@/
    let previous_cursor_line=line('.')
    let previous_cursor_column=col('.')
    %s/\s\+$//ge
    let @/=previous_search
    call cursor(previous_cursor_line, previous_cursor_column)
endfunc

function! RetabIndents()
" Funció que canvia espais per tabs al principi de línia del buffer
    let previous_search=@/
    let previous_cursor_line=line('.')
    let previous_cursor_column=col('.')
    if &expandtab
        execute '%s@^\(\t\)\+@\=repeat(repeat(" ", '.&ts.'), len(submatch(0)))@e'
    else
        execute '%s@^\(\ \{'.&ts.'\}\)\+@\=repeat("\t", len(submatch(0))/'.&ts.')@e'
    endif
    let @/=previous_search
    call cursor(previous_cursor_line, previous_cursor_column)
endfunc

" Use Q to intelligently close a window
" (if there are multiple windows into the same buffer)
" or kill the buffer entirely if it's the last window looking into that buffer
function! CloseWindowOrKillBuffer()
    let number_of_windows_to_this_buffer = len(filter(range(1, winnr('$')), "winbufnr(v:val) == bufnr('%')"))

    " We should never bdelete a nerd tree
    if matchstr(expand("%"), 'NERD') == 'NERD'
        wincmd c
        return
    endif

    if number_of_windows_to_this_buffer > 1
        wincmd c
    else
        bdelete
    endif
endfunction

command! -nargs=0 -bar Qargs execute 'args' QuickfixFilenames()
function! QuickfixFilenames()
  " Building a hash ensures we get each buffer only once
  let buffer_numbers = {}
  for quickfix_item in getqflist()
    let buffer_numbers[quickfix_item['bufnr']] = bufname(quickfix_item['bufnr'])
  endfor
  return join(map(values(buffer_numbers), 'fnameescape(v:val)'))
endfunction


""""""""""""""""""""""""""""""""""""""""""""""""""
" Creació de directoris
""""""""""""""""""""""""""""""""""""""""""""""""""
:silent call EnsureDirExists($HOME.'/.vim_backup')           " Crear directori de backup
" :silent call EnsureDirExists($HOME.'/.vim_swap')             " Crear directori de swap
:silent call EnsureDirExists($HOME.'/.vim_undo')             " Crear directori de undo
:silent call EnsureDirExists($HOME.'/.vim_view')             " Crear directori de view
:silent call EnsureDirExists($HOME.'/.vim_sessions')         " Crear directori de sessions


""""""""""""""""""""""""""""""""""""""""""""""""""
" General
""""""""""""""""""""""""""""""""""""""""""""""""""

" Mantenir la posició del cursor quan obres un buffer al mateix lloc a on el tenies al tancar-lo
autocmd BufWinLeave *.* silent! mkview
autocmd BufWinEnter *.* silent! loadview
autocmd FocusLost *.* silent! :wa

" When restoring a hidden buffer Vim doesn't always keep the same view (like
" when your view shows beyond the end of the file). (Vim tip 1375)
if ! &diff
    au BufLeave * let b:winview = winsaveview()
    au BufEnter * if(exists('b:winview')) | call winrestview(b:winview) | endif
endif

" Posar al títol de la finestra el path del buffer que estem editant
let &titlestring = expand('%:pwd')
if &term == 'screen' || &term == 'xterm'
    set title
endif

" keyboard shortcuts
let mapleader = " "

set autoindent                                               " Activar autoindendació
set autoread                                                 " Reload files when changed on disk, i.e. via `git checkout`
set backspace=2                                              " Fix broken backspace in some setups
set backupdir=~/.vim_backup                                  " Canviar directori de buffer de backup
if has('mac')
    set clipboard=unnamed                                    " Yank and paste with the system clipboard
elseif has('unix')
    set clipboard=unnamedplus                                " Yank and paste with the system clipboard
endif
set cursorline                                               " Ressalta la línia a on està el cursor
set encoding=utf-8                                           " Posar utf-8 com a encoding per defecte
set expandtab tabstop=4 softtabstop=4 shiftwidth=4           " Definir els tabs com 4 espais
set foldlevel=99
set foldmethod=indent                                        " Es creen folds directament amb la indentació
set foldnestmax=1                                            " Perquè es crein folds només al primer nivell d'indentació
set hidden                                                   " Permet moure entre buffers encara que aquests estiguin editats sense guardar
set history=10000                                            " Guarda les 10000 últimes comandes
set hlsearch                                                 " Es ressalten les coincidencies de la cerca
set ignorecase                                               " Case-sensitive search if any caps
set incsearch                                                " Search as you type
set infercase                                                " Per fer case sensitive l'autocomplete
set iskeyword+=_,@                                           " Not word dividers
set laststatus=2                                             " Always show statusline
set lazyredraw                                               " No repinta la pantalla mentre s'executen macros, més ràpid
set linebreak
set nolist                                                   " No ressaltar els caràcters especials
set listchars=tab:▸\ ,trail:▫,eol:↵,extends:»,precedes:«     " Llistat de caràcters especials que es ressalten
set mouse=                                                   " Deshabilitar el ratolí
set noerrorbells                                             " No vull errors sonors
set visualbell                                               " No vull errors visuals
set nowrap sidescroll=1 sidescrolloff=1                      " No tallar frases
set noswapfile
set nrformats=                                               " Per utilitzar el sistema decimal, no octal a l'incrementar o decrementar números
set number                                                   " Show line numbers
set relativenumber                                           " Shows relative numbers
set ruler                                                    " Show where you are
set showcmd                                                  " Mostra els parcials de les comandes
set showtabline=2                                            " Mostra la barra de tabs/buffers sempre
set smartcase                                                " Case-sensitive search if any caps
set splitright splitbelow                                    " Obre les noves finestres a la dreta i a sota
set switchbuf=usetab                                         " A l'obrir un nou fitxer posiciona a la tab/finestra que el tingui, no l'obre de nou
set tags=tags                                                " Afegir tags del virtualenv als tags per defecte
set undodir=~/.vim_undo                                      " Canviar directori de fitxers de undo
set undofile                                                 " Undo persistent, encara que es tanqui el buffer
set undolevels=10000                                         " Augmenta a 10000 el nivel de undo
set undoreload=10000                                         " Augmenta a 10000 el nivel de redo
set viewdir=~/.vim_view                                      " Canviar directori de fitxers de view
set wildignore=*/tmp/,*/.git/*,*.so,*.swp,*.zip,*.pdf,*.bak,*.pyc,*.pyo,*.class,*.tmp,*~      " Ignorar aquests tipus de fitxers
set wildmenu                                                 " Show a navigable menu for tab completion on command line
set wildmode=full                                            " Mostra les possibilitats d'una comanda rotllo zsh
if !has('nvim')
    set term=screen-256color
endif
set pastetoggle=<f5>

set path+=**
set suffixesadd+=.php,.py

" TAGS
autocmd BufNewFile,BufRead *.h,*.m set tags+=~/Documents/global-objc-tags

" Activar colors al text
syntax on

set t_Co=256                                                 " Número de colors
set termguicolors
let base16colorspace=256
set background=dark
colorscheme solarized8
highlight SpecialKey ctermbg=NONE guibg=NONE
" Highlights selection in yellow
hi Visual cterm=reverse guifg=#b4881d guibg=#022b35
if !has('gui_running')
    highlight Normal ctermbg=NONE guibg=NONE
endif

" set Vim-specific sequences for RGB colors
let &t_8f = "\<Esc>[38;2;%lu;%lu;%lum"
let &t_8b = "\<Esc>[48;2;%lu;%lu;%lum"


""""""""""""""""""""""""""""""""""""""""""""""""""
" Mapeig de teclat en mode inserció
""""""""""""""""""""""""""""""""""""""""""""""""""

" Anar al mode normal des del mode insert amb jj
inoremap jj <Esc>


""""""""""""""""""""""""""""""""""""""""""""""""""
" Mapeig de teclat en mode comanda
""""""""""""""""""""""""""""""""""""""""""""""""""

" Escriu a la línia de comandes el directori actual posant %%
cnoremap %% <C-R>=fnameescape(expand('%:h')).'/'<Cr>

" Permet moure's per la història de comandes amb <C-n> i <C-p>
cnoremap <C-p> <Up>
cnoremap <C-n> <Down>

cmap w!! w !sudo tee % >/dev/null


""""""""""""""""""""""""""""""""""""""""""""""""""
" Mapeig de comandes
""""""""""""""""""""""""""""""""""""""""""""""""""

" Si escribim malament el guardar i/o sortir de vim, que funcioni
command! WQ wq
command! Wq wq
command! W w
command! Q q

command! Qa qa


""""""""""""""""""""""""""""""""""""""""""""""""""
" Mapeig de teclat en mode normal
""""""""""""""""""""""""""""""""""""""""""""""""""

" Tracta les línies llarques com a línies separades
map j gj
map k gk

" Moure a la finestra dreta amb Ctrl-H
nmap <C-h> <C-w>h
" Moure a la finestra inferior amb Ctrl-J
nmap <C-j> <C-w>j
" Moure a la finestra superior amb Ctrl-K
nmap <C-k> <C-w>k
" Moure a la finestra esquerra amb Ctrl-L
nmap <C-l> <C-w>l

map gb :bnext<Cr>
map gB :bprevious<Cr>

" Per fer redo es pot amb <C-r> i amb U
nnoremap U <C-r>
nnoremap :: @:

" Centra verticalment cada nova ocurrència d'una cerca
nnoremap n nzz
nnoremap N Nzz

" Copiar del caràcter actual al final de línia amb la tecla Y, per similitud amb D i C
nmap Y y$

" Separar línies amb K
nnoremap K i<Cr><Esc>^

" Guardar el buffer actual amb <Leader>w
nnoremap <Leader>w :w<CR>
" Guardar el buffer actual i tancar-lo amb <Leader>W
nnoremap <Leader>W :wq<CR>

" Posar la configuració de tabs a 2 espais amb <Leader><Leader>2
nnoremap <Leader><Leader>2 <Esc>:set noexpandtab tabstop=2 softtabstop=2 shiftwidth=2<Cr>
" Posar la configuració de tabs a 4 espais amb <Leader><Leader>4
nnoremap <Leader><Leader>4 <Esc>:set noexpandtab tabstop=4 softtabstop=4 shiftwidth=4<Cr>
" Posar la configuració de 4 espais amb <leader><leader>0
nnoremap <Leader><Leader>0 <Esc>:set expandtab tabstop=4 softtabstop=4 shiftwidth=4<Cr>

" Utilitzar Q per tancar buffers
nnoremap <silent> Q :call CloseWindowOrKillBuffer()<Cr>

" Per seleccionar l'últim text enganxat
nnoremap <expr> gv '`[' . strpart(getregtype(), 0, 1) . '`]'

" Indica un nom de fitxer pel buffer actual
map <Leader>c :f <C-R>=expand('%:p:h') . '/' <Cr>

map <Leader>n :enew<Cr>i

" Esborra els espais al final de totes les línies amb <Leader>dt
noremap <silent> <Leader>dt :call DeleteTrailingWS()<Cr>
" Canvia els espais per tabuladors al principi de totes les línies amb <Leader>ri
noremap <silent> <Leader>ri :call RetabIndents()<Cr>

" Repeteix la última cerca amb els mateixos flags amb & en mode normal, visual o de selecció
nnoremap & :&&<CR>
xnoremap & :&&<CR>

if has('nvim')
    " Sortir del terminal de neovim amb Esc
  tnoremap <Esc> <C-\><C-n>
endif

augroup CursorLineOnlyInActiveWindow
    autocmd!
    autocmd VimEnter,WinEnter,BufWinEnter * setlocal cursorline
    autocmd WinLeave * setlocal nocursorline
augroup END

if has("eval")
    function! SL(function)
        if exists('*'.a:function)
            return call(a:function,[])
        else
            return ''
        endif
    endfunction
endif


""""""""""""""""""""""""""""""""""""""""""""""""""
" Configuració de plugins
""""""""""""""""""""""""""""""""""""""""""""""""""

if has('nvim')
    " fzf-preview.vim
    hi Floating guibg=#1B1B1B

    nnoremap <Leader>ff     :<C-u>FzfPreviewDirectoryFiles<CR>
    nnoremap <Leader>fgs    :<C-u>FzfPreviewGitStatus<CR>
    nnoremap <Leader>fgf    :<C-u>FzfPreviewGitFiles<CR>
    nnoremap <Leader>fb     :<C-u>FzfPreviewBuffers<CR>
    nnoremap <Leader>fgr    :<C-u>FzfPreviewProjectGrep<Space>
    nnoremap <Leader>ft     :<C-u>FzfPreviewBufferTags<CR>
else
    let g:fzf_preview_use_floating_window = 0
    nmap <Leader>f :FZF<Cr>
    nmap <Leader>b :Buffers<Cr>
    nmap <Leader>. :Tags<Cr>:Tags<Cr>
    let $FZF_DEFAULT_COMMAND = 'ag -g ""'

    function! s:fzf_statusline()
        highlight fzf1 ctermfg=161 ctermbg=251
        highlight fzf2 ctermfg=23 ctermbg=251
        highlight fzf3 ctermfg=237 ctermbg=251
        setlocal statusline=%#fzf1#\ >\ %#fzf2#fz%#fzf3#f
    endfunction
    autocmd! User FzfStatusLine call <SID>fzf_statusline()
endif

" vim-g: Obre finestra al navegador amb el text a buscar
let g:vim_g_query_url = "https://duckduckgo.com/?q="
let g:vim_g_command = "Go"

" undotree
nnoremap <Leader>u :call undotree#UndotreeToggle()<Cr>

" vim-session
let g:session_directory = '~/.vim_sessions'
let g:session_autoload = 'yes'
let g:session_autosave = 'yes'
let g:session_command_aliases = 1
nnoremap <Leader>so :OpenSession
nnoremap <Leader>ss :SaveSession
nnoremap <Leader>sd :DeleteSession<Cr>
nnoremap <Leader>sc :CloseSession<Cr>

" vim-airline: Línia de status i de buffers
let g:airline_section_c = '%f'
let g:airline_section_y = ''
let g:airline#extensions#tagbar#enabled = 0
let g:airline#extensions#hunks#enabled = 0
let g:airline#extensions#virtualenv#enabled = 0
let g:airline_left_sep=''
let g:airline_right_sep=''
let g:airline#extensions#tabline#show_buffers = 1
let g:airline#extensions#tabline#enabled = 1
let g:airline#extensions#tabline#formatter = 'unique_tail_improved'
let g:airline#extensions#tabline#buffer_nr_show = 1
let g:airline#extensions#bufferline#enabled = 1
let g:airline#extensions#whitespace#checks = []

" vim-grepper:
nmap gs <plug>(GrepperOperator)
xmap gs <plug>(GrepperOperator)

nnoremap <leader>gg :Grepper -tool git<cr>
nnoremap <leader>gr :Grepper -tool rg<cr>
nnoremap <leader>ga :Grepper -tool ag<cr>
nnoremap <leader>gs :Grepper -tool ag -side<cr>
nnoremap <leader>*  :Grepper -tool ag -cword -noprompt<cr>

let g:grepper           = {}
let g:grepper.tools     = ['git', 'ag', 'grep', 'rg']
let g:grepper.open      = 1
let g:grepper.jump      = 0
let g:grepper.next_tool = '<leader>g'

command! Todo Grepper -tool git -query -E '(TODO|FIXME|XXX):'
